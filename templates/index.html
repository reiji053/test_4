from flask import Flask, render_template, request, session, url_for, redirect
from datetime import datetime
import base64
import hashlib
import secrets
import os
import psycopg2
import psycopg2.extras
from dotenv import load_dotenv

UPLOAD_FOLDER = os.path.join('static', 'uploads')
os.makedirs(UPLOAD_FOLDER, exist_ok=True)

HASH_ALGORITHM = "pbkdf2_sha256"

app = Flask(__name__)
app.secret_key = b'opensesame'

load_dotenv(".env.local")

def get_db():
    db_url = os.environ.get("DATABASE_URL")
    conn = psycopg2.connect(db_url, sslmode='require', cursor_factory=psycopg2.extras.DictCursor)
    return conn

def hash_password(password, salt=None, iterations=310000):
    if salt is None:
        salt = secrets.token_hex(16)
    pw_hash = hashlib.pbkdf2_hmac("sha256", password.encode("utf-8"), salt.encode("utf-8"), iterations)
    b64_hash = base64.b64encode(pw_hash).decode("ascii").strip()
    return f"{HASH_ALGORITHM}${iterations}${salt}${b64_hash}"

def verify_password(password, password_hash):
    if (password_hash or "").count("$") != 3:
        return False
    algorithm, iterations, salt, _ = password_hash.split("$", 3)
    iterations = int(iterations)
    assert algorithm == HASH_ALGORITHM
    compare_hash = hash_password(password, salt, iterations)
    return secrets.compare_digest(password_hash, compare_hash)

@app.route("/logout")
def logout():
    session.pop("user_id", None)
    return redirect(url_for("index"))

@app.route("/login", methods=["GET"])
def login_form():
    return render_template("login.html")

@app.route("/login", methods=["POST"])
def login():
    username = request.form.get("username")
    password = request.form.get("password")
    if not username or not password:
        return render_template("login.html", error_user=True, form=request.form)

    db = get_db()
    try:
        with db:
            cursor = db.cursor()
            cursor.execute("SELECT * FROM users WHERE username = %s", (username,))
            row = cursor.fetchone()

            if row and verify_password(password, row["password_hash"]):
                session["user_id"] = row["id"]
                return redirect(url_for("home2_html"))
            else:
                return render_template("login.html", error_login=True)
    finally:
        db.close()

@app.route("/register", methods=["GET"])
def register_form():
    return render_template("register.html")

@app.route("/register", methods=["POST"])
def register():
    username = request.form.get("username")
    password = request.form.get("password")
    password_confirmation = request.form.get("password_confirmation")

    if not username or len(username) < 3:
        return render_template("register.html", error_user=True, form=request.form)
    if not password:
        return render_template("register.html", error_password=True, form=request.form)
    if password != password_confirmation:
        return render_template("register.html", error_confirm=True, form=request.form)

    db = get_db()
    try:
        with db:
            cursor = db.cursor()
            cursor.execute("SELECT * FROM users WHERE username = %s", (username,))
            if cursor.fetchone():
                return render_template("register.html", error_unique=True, form=request.form)

            password_hash = hash_password(password)
            cursor.execute("INSERT INTO users (username, password_hash) VALUES (%s, %s)", (username, password_hash))
        db.commit()
        return redirect(url_for("home2_html"))
    finally:
        db.close()

@app.route('/', methods=['GET'])
def index():
    return redirect(url_for("home_redirect"))

@app.route('/home', methods=['GET'])
def home_redirect():
    # ðŸ”½ ã‚²ã‚¹ãƒˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç”¨ã®ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸
    return render_template("home.html")

@app.route('/home2', endpoint='home2_html', methods=['GET'])
def home2():
    user_id = session.get("user_id")
    query_books = "SELECT id, title, episord_title, main_text, create_name, img FROM books"
    if user_id:
        query_books += f" WHERE user_id = {user_id}"

    db = get_db()
    with db:
        cursor = db.cursor()
        cursor.execute(query_books)
        books = cursor.fetchall()
        cursor.execute("SELECT id, username FROM users")
        users = cursor.fetchall()
    db.close()
    return render_template('home2.html', books=books, users=users)

@app.route('/create', methods=['GET', 'POST'])
def create():
    if request.method == 'POST':
        create_name = request.form.get('create_name')
        title = request.form.get('title')
        episord_title = request.form.get('episord_title')
        main_text = request.form.get('main_text')

        file = request.files.get('img')
        if not file or file.filename == '':
            return 'ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠžã•ã‚Œã¦ã„ã¾ã›ã‚“', 400

        file_path = os.path.join(UPLOAD_FOLDER, file.filename)
        file.save(file_path)

        db = get_db()
        try:
            with db:
                cursor = db.cursor()
                cursor.execute("""
                    INSERT INTO books (create_name, title, episord_title, main_text, create_at, img)
                    VALUES (%s, %s, %s, %s, %s, %s)
                """, (create_name, title, episord_title, main_text, datetime.now(), file.filename))
            db.commit()
        finally:
            db.close()

        return redirect(url_for('home2_html'))
    return render_template('create.html')

@app.route('/book/<post_id>', methods=['GET'])
def book(post_id):
    db = get_db()
    with db:
        cursor = db.cursor()
        cursor.execute("SELECT id, title, episord_title, main_text, create_name, img FROM books WHERE id = %s", (post_id,))
        books = cursor.fetchall()
    db.close()
    return render_template('book.html', books=books)